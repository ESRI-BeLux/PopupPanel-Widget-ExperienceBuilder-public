/*! For license information please see widget.js.LICENSE.txt */
System.register(["jimu-arcgis","jimu-core","esri/core/Handles","esri/layers/FeatureLayer","esri/support/popupUtils","calcite-components","esri/core/lang","esri/widgets/Feature","esri/core/reactiveUtils","esri/widgets/Editor","esri/Graphic","esri/core/promiseUtils","esri/layers/GroupLayer"],(function(e,t){var a={},i={},r={},n={},s={},o={},l={},c={},p={},h={},d={},u={},m={};return{setters:[function(e){a.JimuMapViewComponent=e.JimuMapViewComponent},function(e){i.React=e.React,i.ReactDOM=e.ReactDOM,i.SessionManager=e.SessionManager,i.WidgetState=e.WidgetState,i.getAppStore=e.getAppStore,i.jsx=e.jsx},function(e){r.default=e.default},function(e){n.default=e.default},function(e){s.default=e.default},function(e){o.CalciteAction=e.CalciteAction,o.CalciteButton=e.CalciteButton,o.CalciteCombobox=e.CalciteCombobox,o.CalciteComboboxItem=e.CalciteComboboxItem,o.CalciteInput=e.CalciteInput,o.CalciteLabel=e.CalciteLabel,o.CalciteLink=e.CalciteLink,o.CalciteListItem=e.CalciteListItem,o.CalciteNotice=e.CalciteNotice,o.CalcitePanel=e.CalcitePanel,o.CalcitePickList=e.CalcitePickList,o.CalcitePickListGroup=e.CalcitePickListGroup,o.CalcitePickListItem=e.CalcitePickListItem,o.CalciteTab=e.CalciteTab,o.CalciteTabNav=e.CalciteTabNav,o.CalciteTabTitle=e.CalciteTabTitle,o.CalciteTabs=e.CalciteTabs},function(e){l.default=e.default},function(e){c.default=e.default},function(e){p.default=e.default},function(e){h.default=e.default},function(e){d.default=e.default},function(e){u.default=e.default},function(e){m.default=e.default}],execute:function(){e((()=>{var e={8198:(e,t,a)=>{"use strict";a.d(t,{Z:()=>o});var i=a(8081),r=a.n(i),n=a(3645),s=a.n(n)()(r());s.push([e.id,".esri-editor.esri-widget.esri-widget--panel{height:100%}\n",""]);const o=s},3645:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var a="",i=void 0!==t[5];return t[4]&&(a+="@supports (".concat(t[4],") {")),t[2]&&(a+="@media ".concat(t[2]," {")),i&&(a+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),a+=e(t),i&&(a+="}"),t[2]&&(a+="}"),t[4]&&(a+="}"),a})).join("")},t.i=function(e,a,i,r,n){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(i)for(var o=0;o<this.length;o++){var l=this[o][0];null!=l&&(s[l]=!0)}for(var c=0;c<e.length;c++){var p=[].concat(e[c]);i&&s[p[0]]||(void 0!==n&&(void 0===p[5]||(p[1]="@layer".concat(p[5].length>0?" ".concat(p[5]):""," {").concat(p[1],"}")),p[5]=n),a&&(p[2]?(p[1]="@media ".concat(p[2]," {").concat(p[1],"}"),p[2]=a):p[2]=a),r&&(p[4]?(p[1]="@supports (".concat(p[4],") {").concat(p[1],"}"),p[4]=r):p[4]="".concat(r)),t.push(p))}},t}},8081:e=>{"use strict";e.exports=function(e){return e[1]}},3379:e=>{"use strict";var t=[];function a(e){for(var a=-1,i=0;i<t.length;i++)if(t[i].identifier===e){a=i;break}return a}function i(e,i){for(var n={},s=[],o=0;o<e.length;o++){var l=e[o],c=i.base?l[0]+i.base:l[0],p=n[c]||0,h="".concat(c," ").concat(p);n[c]=p+1;var d=a(h),u={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==d)t[d].references++,t[d].updater(u);else{var m=r(u,i);i.byIndex=o,t.splice(o,0,{identifier:h,updater:m,references:1})}s.push(h)}return s}function r(e,t){var a=t.domAPI(t);return a.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;a.update(e=t)}else a.remove()}}e.exports=function(e,r){var n=i(e=e||[],r=r||{});return function(e){e=e||[];for(var s=0;s<n.length;s++){var o=a(n[s]);t[o].references--}for(var l=i(e,r),c=0;c<n.length;c++){var p=a(n[c]);0===t[p].references&&(t[p].updater(),t.splice(p,1))}n=l}}},569:e=>{"use strict";var t={};e.exports=function(e,a){var i=function(e){if(void 0===t[e]){var a=document.querySelector(e);if(window.HTMLIFrameElement&&a instanceof window.HTMLIFrameElement)try{a=a.contentDocument.head}catch(e){a=null}t[e]=a}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(a)}},9216:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},3565:(e,t,a)=>{"use strict";e.exports=function(e){var t=a.nc;t&&e.setAttribute("nonce",t)}},7795:e=>{"use strict";e.exports=function(e){var t=e.insertStyleElement(e);return{update:function(a){!function(e,t,a){var i="";a.supports&&(i+="@supports (".concat(a.supports,") {")),a.media&&(i+="@media ".concat(a.media," {"));var r=void 0!==a.layer;r&&(i+="@layer".concat(a.layer.length>0?" ".concat(a.layer):""," {")),i+=a.css,r&&(i+="}"),a.media&&(i+="}"),a.supports&&(i+="}");var n=a.sourceMap;n&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(n))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,a)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},4589:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},4145:e=>{"use strict";e.exports=o},4129:e=>{"use strict";e.exports=d},4258:e=>{"use strict";e.exports=r},7970:e=>{"use strict";e.exports=l},7780:e=>{"use strict";e.exports=u},135:e=>{"use strict";e.exports=p},9168:e=>{"use strict";e.exports=n},8393:e=>{"use strict";e.exports=m},4119:e=>{"use strict";e.exports=s},8359:e=>{"use strict";e.exports=h},5894:e=>{"use strict";e.exports=c},6826:e=>{"use strict";e.exports=a},8891:e=>{"use strict";e.exports=i}},t={};function g(a){var i=t[a];if(void 0!==i)return i.exports;var r=t[a]={id:a,exports:{}};return e[a](r,r.exports,g),r.exports}g.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return g.d(t,{a:t}),t},g.d=(e,t)=>{for(var a in t)g.o(t,a)&&!g.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},g.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),g.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},g.p="",g.nc=void 0;var f={};return g.p=window.jimuConfig.baseUrl,(()=>{"use strict";g.r(f),g.d(f,{default:()=>J});var e=g(6826),t=g(8891),a=g(3379),i=g.n(a),r=g(7795),n=g.n(r),s=g(569),o=g.n(s),l=g(3565),c=g.n(l),p=g(9216),h=g.n(p),d=g(4589),u=g.n(d),m=g(8198),y={};y.styleTagTransform=u(),y.setAttributes=c(),y.insert=o().bind(null,"head"),y.domAPI=n(),y.insertStyleElement=h(),i()(m.Z,y),m.Z&&m.Z.locals&&m.Z.locals;var b=function(e,t){return b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])},b(e,t)},C=function(){return C=Object.assign||function(e){for(var t,a=1,i=arguments.length;a<i;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},C.apply(this,arguments)};function R(e){return Object.keys(e).some((function(t){var a=e[t];if(!a)return!1;switch(a&&a.toParam&&(a=a.toParam()),a.constructor.name){case"Array":case"Object":case"Date":case"Function":case"Boolean":case"String":case"Number":return!1;default:return!0}}))}function v(e){var t={};return Object.keys(e).forEach((function(a){var i,r,n=e[a];if(n&&n.toParam&&(n=n.toParam()),n||0===n||"boolean"==typeof n||"string"==typeof n){var s;switch(n.constructor.name){case"Array":var o=null===(r=null===(i=n[0])||void 0===i?void 0:i.constructor)||void 0===r?void 0:r.name;s="Array"===o?n:"Object"===o?JSON.stringify(n):n.join(",");break;case"Object":s=JSON.stringify(n);break;case"Date":s=n.valueOf();break;case"Function":s=null;break;case"Boolean":s=n+"";break;default:s=n}(s||0===s||"string"==typeof s||Array.isArray(s))&&(t[a]=s)}})),t}function E(e,t){return Array.isArray(t)&&t[0]&&Array.isArray(t[0])?t.map((function(t){return E(e,t)})).join("&"):encodeURIComponent(e)+"="+encodeURIComponent(t)}function w(e){var t=v(e);return Object.keys(t).map((function(e){return E(e,t[e])})).join("&")}var G=function(e,t,a,i,r){e=e||"UNKNOWN_ERROR",t=t||"UNKNOWN_ERROR_CODE",this.name="ArcGISRequestError",this.message="UNKNOWN_ERROR_CODE"===t?e:t+": "+e,this.originalMessage=e,this.code=t,this.response=a,this.url=i,this.options=r};(G.prototype=Object.create(Error.prototype)).constructor=G;var S={httpMethod:"POST",params:{f:"json"}},T=function(e){function t(t,a,i,r,n){void 0===t&&(t="AUTHENTICATION_ERROR"),void 0===a&&(a="AUTHENTICATION_ERROR_CODE");var s=e.call(this,t,a,i,r,n)||this;return s.name="ArcGISAuthError",s.message="AUTHENTICATION_ERROR_CODE"===a?t:a+": "+t,s}return function(e,t){function a(){this.constructor=e}b(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}(t,e),t.prototype.retry=function(e,t){var a=this;void 0===t&&(t=3);var i=0,r=function(n,s){e(a.url,a.options).then((function(e){var t=C(C({},a.options),{authentication:e});return i+=1,x(a.url,t)})).then((function(e){n(e)})).catch((function(e){"ArcGISAuthError"===e.name&&i<t?r(n,s):"ArcGISAuthError"===e.name&&i>=t?s(a):s(e)}))};return new Promise((function(e,t){r(e,t)}))},t}(G);function x(e,t){void 0===t&&(t={params:{f:"json"}});var a=C(C(C({httpMethod:"POST"},S),t),{params:C(C({},S.params),t.params),headers:C(C({},S.headers),t.headers)}),i=[],r=[];if(a.fetch||"undefined"==typeof fetch?(i.push("`fetch`"),r.push("`node-fetch`")):a.fetch=fetch.bind(Function("return this")()),"undefined"==typeof Promise&&(i.push("`Promise`"),r.push("`es6-promise`")),"undefined"==typeof FormData&&(i.push("`FormData`"),r.push("`isomorphic-form-data`")),!a.fetch||"undefined"==typeof Promise||"undefined"==typeof FormData)throw new Error("`arcgis-rest-request` requires a `fetch` implementation and global variables for `Promise` and `FormData` to be present in the global scope. You are missing "+i.join(", ")+". We recommend installing the "+r.join(", ")+" modules at the root of your application to add these to the global scope. See https://bit.ly/2KNwWaJ for more info.");var n=a.httpMethod,s=a.authentication,o=a.rawResponse,l=C({f:"json"},a.params),c=null,p={method:n,credentials:a.credentials||"same-origin"};return a.headers&&a.headers["X-Esri-Auth-Client-Id"]&&e.indexOf("/oauth2/platformSelf")>-1&&(p.credentials="include"),(s?s.getToken(e,{fetch:a.fetch}).catch((function(t){return t.url=e,t.options=a,c=t,Promise.resolve("")})):Promise.resolve("")).then((function(t){t.length&&(l.token=t),s&&s.getDomainCredentials&&(p.credentials=s.getDomainCredentials(e));var i={};if("GET"===p.method){l.token&&a.hideToken&&"undefined"==typeof window&&(i["X-Esri-Authorization"]="Bearer "+l.token,delete l.token);var r=""===w(l)?e:e+"?"+w(l);a.maxUrlLength&&r.length>a.maxUrlLength||l.token&&a.hideToken?(p.method="POST",t.length&&a.hideToken&&(l.token=t,delete i["X-Esri-Authorization"])):e=r}var n=new RegExp("/items/.+/updateResources").test(e);return"POST"===p.method&&(p.body=function(e,t){var a=R(e)||t,i=v(e);if(a){var r=new FormData;return Object.keys(i).forEach((function(e){if("undefined"!=typeof Blob&&i[e]instanceof Blob){var t=i.fileName||i[e].name||e;r.append(e,i[e],t)}else r.append(e,i[e])})),r}return w(e)}(l,n)),p.headers=C(C({},i),a.headers),"undefined"!=typeof window||p.headers.referer||(p.headers.referer="@esri/arcgis-rest-js"),R(l)||n||(p.headers["Content-Type"]="application/x-www-form-urlencoded"),a.fetch(e,p)})).then((function(t){if(!t.ok){var i=t.status,r=t.statusText;throw new G(r,"HTTP "+i,t,e,a)}if(o)return t;switch(l.f){case"json":case"geojson":return t.json();case"html":case"text":return t.text();default:return t.blob()}})).then((function(t){if("json"!==l.f&&"geojson"!==l.f||o)return t;var i=function(e,t,a,i,r){if(e.code>=400){var n=e.message,s=e.code;throw new G(n,s,e,t,i)}if(e.error){var o=e.error,l=(n=o.message,s=o.code,o.messageCode),c=l||s||"UNKNOWN_ERROR_CODE";if(498===s||499===s||"GWM_0003"===l||400===s&&"Unable to generate token."===n)throw r||new T(n,c,e,t,i);throw new G(n,c,e,t,i)}if("failed"===e.status||"failure"===e.status){n=void 0,s="UNKNOWN_ERROR_CODE";try{n=JSON.parse(e.statusMessage).message,s=JSON.parse(e.statusMessage).code}catch(t){n=e.statusMessage||e.message}throw new G(n,s,e,t,i)}return e}(t,e,0,a,c);if(c){var r=e.toLowerCase().split(/\/rest(\/admin)?\/services\//)[0];a.authentication.federatedServers[r]={token:[],expires:new Date(Date.now()+864e5)},c=null}return i}))}var I=g(4258),P=g(9168),F=g(4119);class O extends t.React.PureComponent{constructor(e){super(e),this.getNext=()=>{console.log("getNext"),this.props.primaryGraphicIndex<this.props.primaryGraphicList.length-1&&this.props.onIndexChange(this.props.primaryGraphicIndex+1)},this.getPrevious=()=>{console.log("getPrevious"),this.props.primaryGraphicIndex>0&&this.props.onIndexChange(this.props.primaryGraphicIndex-1)},this.state={},console.log("THIS ROPS.",e)}componentDidMount(){console.log("componentDidMount")}render(){const{primaryGraphicList:e,primaryGraphicIndex:a}=this.props;return t.React.createElement(t.React.Fragment,null,t.React.createElement("div",{style:{display:"flex",justifyContent:"center",alignContent:"center",flexDirection:"column",height:"100%"}},t.React.createElement("div",{className:"esri-popup__navigation"},t.React.createElement("div",{style:{backgroundColor:"transparent"},className:"esri-popup__button esri-popup__pagination-previous",title:"Previous item",onClick:this.getPrevious},t.React.createElement("span",{className:"esri-popup__icon esri-icon-left-triangle-arrow esri-popup__pagination-previous-icon"})),t.React.createElement("div",{style:{backgroundColor:"transparent"},title:"Number of items"},e.indexOf(e[a])+1," ","of ",e.length),t.React.createElement("div",{style:{backgroundColor:"transparent"},className:"esri-popup__button esri-popup__pagination-next",title:"Next item",onClick:this.getNext},t.React.createElement("span",{className:"esri-popup__icon esri-icon-right-triangle-arrow esri-popup__pagination-next-icon"})))))}}var N=g(4145),L=g(7970),k=g(5894);class D extends t.React.PureComponent{constructor(e){super(e),this.state={},this.featureContainer=t.React.createRef()}destroyFeature(){this.feature&&!this.feature.destroyed&&this.feature.destroy()}componentDidMount(){console.log("componentDidMount");const{graphic:e,view:t}=this.props;this.feature=new k.default({container:this.featureContainer.current,graphic:this.props.graphic,map:this.props.view.map,spatialReference:this.props.view.spatialReference})}render(){return t.React.createElement(t.React.Fragment,null,t.React.createElement("div",{className:"feature-custom-styling"},t.React.createElement("div",{className:"jimu-widget",ref:this.featureContainer})))}}var M=g(135);class j extends t.React.PureComponent{constructor(e){super(e),this.goBack=e=>{e.displayedGraphic.groupRelatedChildrenGraphics=[],e.displayedGraphic=null,this.props.updatePrimary()},this.displayPopupTitle=e=>{const t=e.popupTemplate.title.toString(),a=e.attributes,i=e.layer.fields.filter((e=>"date"===e.type)).map((e=>e.name));for(var r=t,n=/{([^}]+)}/g,s=null;s=n.exec(t);)if(i.includes(s[1])){const e=new Date(a[s[1]]);r=this.replaceAll(r,s[0],e.toLocaleDateString())}else r=this.replaceAll(r,s[0],a[s[1]]);return r},this.getHighlightButton=e=>t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"auto",iconStart:"highlighter",onClick:()=>{this.props.widget.highlightGraphic(e.layer,e)}},"Sélectionner"),this.getEditButton=e=>{const a=e.layer;if(a.editingEnabled)return t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"auto",iconStart:"pencil",onClick:()=>{a.isTable?this.props.editorComponent.updateTableGraphic(a,e):this.props.editorComponent.updateGraphic(e)}},"Modifier")},this.getDeleteButton=(e,a)=>{const i=e.layer;if(console.log("layer capabilities",i.capabilities),i.editingEnabled&&i.capabilities&&i.capabilities.operations&&i.capabilities.operations.supportsDelete){const i=this.generateUUID();return t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteButton,{id:i,className:"m-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"auto",iconStart:"trash",onClick:()=>{this.setState({openConfirmDeleteModal:{showModal:!0,ConfirmDeleteParameters:{graphic:e,groupRelatedGraphics:a}}})}},"Supprimer"))}},this.getCreateChildButton=e=>{if(e.groupRelatedChildrenGraphics.length)return e.groupRelatedChildrenGraphics.map(((a,i)=>{if(a.layerFromMap&&a.layerFromMap.editingEnabled)return t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"auto",iconStart:"pencil",onClick:()=>{a.layerFromMap.isTable?this.props.editorComponent.createTableChildGraphic(e.graphic,a.layerFromMap,a.relationship):this.props.editorComponent.createChildGraphic(e.graphic,a.layerFromMap,a.relationship)}},"Créer (",a.layerFromMap.title,")")}))},this.onCalciteListItemChange=(e,t)=>{const a=t.target.value;e.displayedGraphic=a,this.props.updateStateRelatedGraphic(a,e)},this.onCalciteTabChange=()=>{this.setState({newPrimary:!1})},this.state={newPrimary:!0,openConfirmDeleteModal:{showModal:!1,ConfirmDeleteParameters:void 0}},this.highlightSelect=new I.default,this.calciteTabRef=t.React.createRef(),this.deleteButtonRef=t.React.createRef(),this.deletePopoverRef=t.React.createRef(),this.primaryTabNav=t.React.createRef()}componentDidMount(){console.log("componentDidMount")}componentDidUpdate(e,t){e.primaryGraphic!==this.props.primaryGraphic&&e.primaryGraphic.graphic.attributes!==this.props.primaryGraphic.graphic.attributes&&this.setState({newPrimary:!0}),e.primaryGraphic.groupRelatedChildrenGraphics===this.props.primaryGraphic.groupRelatedChildrenGraphics&&e.primaryGraphic.groupRelatedParentGraphics===this.props.primaryGraphic.groupRelatedParentGraphics||this.calciteTabRef.current.childNodes.forEach((e=>{e.active&&setTimeout((()=>{e.active=!1,e.active=!0}),250)}))}goToParent(e){const t=L.default.clone(e),a=[];for(let e=0;e<t.relatedGraphics.length;e++){const i=t.relatedGraphics[e],r={graphic:L.default.clone(i.graphic),name:t.name,layerFromMap:L.default.clone(t.layerFromMap),groupRelatedParentGraphics:[],groupRelatedChildrenGraphics:L.default.clone(i.groupRelatedChildrenGraphics)};a.push(r)}const i=a[0];this.props.updatePrimary(i),this.props.updateStatePrimaryGraphicList(a),this.setState({newPrimary:!0}),this.props.widget.updateStateOriginalScreenPoint(null)}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}replaceAll(e,t,a){return e.replace(new RegExp(this.escapeRegExp(t),"ig"),a)}getRecursiveTabTitle(e,a){return a.map(((a,i)=>{if(a.layerFromMap&&this.verifyGroup(a.relatedGraphics)){let r=`${e}_${i}`;return t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteTabTitle,{key:`${r}`},a.name),a.displayedGraphic&&this.verifyGroup(a.displayedGraphic.groupRelatedChildrenGraphics)&&this.getRecursiveTabTitle(r,a.displayedGraphic.groupRelatedChildrenGraphics))}}))}getRecursiveTab(e,a){return a.map(((a,i)=>{if(a.layerFromMap&&this.verifyGroup(a.relatedGraphics)){let r=`${e}_${i}`;return t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteTab,{key:r},a.displayedGraphic?t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",color:"neutral","icon-start":"arrow-left",alignment:"center",scale:"m",type:"button",width:"auto","calcite-hydrated":"",onClick:e=>this.goBack(a)},"Retour"),a.layerFromMap&&t.React.createElement(t.React.Fragment,null,this.getHighlightButton(a.displayedGraphic.graphic),this.getEditButton(a.displayedGraphic.graphic),this.getDeleteButton(a.displayedGraphic.graphic,a),this.getCreateChildButton(a.displayedGraphic)),t.React.createElement(D,{key:`${r}_${this.props.widget.updateCounter}`,graphic:a.displayedGraphic.graphic,view:this.props.view})):t.React.createElement(N.CalcitePickList,null,a.relatedGraphics.map(((e,i)=>t.React.createElement(N.CalcitePickListItem,{key:`groupRelatedGraphic_${r}_${i}`,label:this.displayPopupTitle(e.graphic),value:e,onCalciteListItemChange:e=>this.onCalciteListItemChange(a,e)}))))),a.displayedGraphic&&this.verifyGroup(a.displayedGraphic.groupRelatedChildrenGraphics)&&this.getRecursiveTab(r,a.displayedGraphic.groupRelatedChildrenGraphics))}}))}deleteOperation(){console.log("deleteOperation"),this.props.updateStateLoading(!0),this.state.openConfirmDeleteModal&&this.setState((e=>({openConfirmDeleteModal:Object.assign(Object.assign({},e.openConfirmDeleteModal),{showModal:!1})})),(()=>{const{graphic:e,groupRelatedGraphics:t}=this.state.openConfirmDeleteModal.ConfirmDeleteParameters;e.layer.isTable?(alert("NOT IMPLEMENTED YET FOR TABLE"),this.props.updateStateLoading(!1)):t?t.relatedGraphics.length>1?(console.log("OPTION 1"),this.props.editorComponent.deleteGraphic(e).then((t=>{const a=e.layer;console.log("DELETE FINI"),this.props.view.whenLayerView(a).then((e=>{console.log("LAYERVIEW"),M.default.once((()=>!1===e.updating)).then((()=>{console.log("UPDATING FINISH"),this.props.widget.resetAll(),this.props.updateStateLoading(!1)}))})).catch((()=>{this.props.updateStateLoading(!1)}))}))):(console.log("OPTION 2"),this.props.editorComponent.deleteGraphic(e).then((t=>{const a=e.layer;console.log("DELETE FINI"),this.props.view.whenLayerView(a).then((e=>{console.log("LAYERVIEW"),M.default.once((()=>!1===e.updating)).then((()=>{console.log("UPDATING FINISH"),this.props.widget.resetAll(),this.props.updateStateLoading(!1)}))})).catch((()=>{this.props.updateStateLoading(!1)}))}))):(console.log("OPTION 3"),this.props.editorComponent.deleteGraphic(e).then((t=>{const a=e.layer;console.log("DELETE FINI"),this.props.view.whenLayerView(a).then((e=>{console.log("LAYERVIEW"),M.default.once((()=>!1===e.updating)).then((()=>{console.log("UPDATING FINISH"),this.props.widget.resetAll(),this.props.updateStateLoading(!1)}))})).catch((()=>{this.props.updateStateLoading(!1)}))})))}))}generateUUID(){var e=(new Date).getTime(),t="undefined"!=typeof performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(a){var i=16*Math.random();return e>0?(i=(e+i)%16|0,e=Math.floor(e/16)):(i=(t+i)%16|0,t=Math.floor(t/16)),("x"===a?i:3&i|8).toString(16)}))}verifyGroup(e){return e&&e.length>0}showConfirmDeleteModal(e,a){return t.React.createElement(t.React.Fragment,null)}render(){const{primaryGraphic:e}=this.props;return t.React.createElement(t.React.Fragment,null,this.state.openConfirmDeleteModal&&this.state.openConfirmDeleteModal.showModal&&t.React.createElement("div",{style:{padding:"0.5em",textAlign:"center",position:"absolute",backgroundColor:"white",borderStyle:"solid",borderWidth:"1px",inset:"auto 0",zIndex:"5"}},t.React.createElement("p",null,"Are you sure you want to delete this feature ?"),t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"auto",iconStart:"check",onClick:()=>{this.deleteOperation()}},"Confirm"),t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"auto",iconStart:"x",onClick:()=>{this.setState((e=>({openConfirmDeleteModal:Object.assign(Object.assign({},e.openConfirmDeleteModal),{showModal:!1})})))}},"Cancel")),t.React.createElement(N.CalciteTabs,{key:e.graphic.uid,className:"p-2"},t.React.createElement(N.CalciteTabNav,{slot:"tab-nav",onCalciteTabChange:e=>{this.onCalciteTabChange(),e.detail.tab&&(this.selectedTab=parseInt(e.detail.tab.toString())||0)},ref:this.calciteTabRef},this.verifyGroup(e.groupRelatedParentGraphics)&&e.groupRelatedParentGraphics.map(((e,a)=>t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteTabTitle,{key:`ParentTitle_${a}`,onClick:t=>this.goToParent(e)},e.name,e.relatedGraphics.length>1&&` (${e.relatedGraphics.length})`)))),t.React.createElement(N.CalciteTabTitle,{active:this.state.newPrimary},e.name),this.verifyGroup(e.groupRelatedChildrenGraphics)&&this.getRecursiveTabTitle(`tabTitle_${e.graphic.getObjectId()}`,e.groupRelatedChildrenGraphics)),this.verifyGroup(e.groupRelatedParentGraphics)&&e.groupRelatedParentGraphics.map(((e,a)=>t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteTab,{key:a},e.name,e.relatedGraphics.length>1&&` (${e.relatedGraphics.length})`)))),t.React.createElement(N.CalciteTab,null,e.layerFromMap&&t.React.createElement(t.React.Fragment,null,this.getHighlightButton(e.graphic),this.getEditButton(e.graphic),this.getDeleteButton(e.graphic,null),this.getCreateChildButton(e)),t.React.createElement(D,{key:`${e.graphic.getObjectId()}_${this.props.widget.updateCounter}`,graphic:e.graphic,view:this.props.view})),this.verifyGroup(e.groupRelatedChildrenGraphics)&&this.getRecursiveTab(`tab_${e.graphic.getObjectId()}`,e.groupRelatedChildrenGraphics)))}}const _={_widgetLabel:"Panneau contextuel (Esri Belux)",panelTitle:"Panneau contextuel",edit:"Modifier",create:"Créer"};var A=g(8359),B=g(4129);class $ extends t.React.PureComponent{constructor(e){super(e),this.state={mode:void 0,createTemplate:void 0}}destroyFeature(){}componentDidMount(){console.log("componentDidMount")}createTableChildGraphic(e,t,a){t.templates[0].prototype.attributes[a.keyField]=e.attributes[a.keyField]}createNewFeature(e){this.setState({createTemplate:e,mode:"creation"},(()=>{this.props.updateEnableTableEditState(!0)}))}createNewChildFeature(e,t){this.setState({createTemplate:e,parentGraphic:t,mode:"creationChild"},(()=>{this.props.updateEnableTableEditState(!0)}))}updateFeature(e,t){this.setState({createTemplate:e,graphic:t,mode:"update"},(()=>{this.props.updateEnableTableEditState(!0)}))}resetAll(){this.setState({mode:null,createTemplate:null}),this.props.updateEnableTableEditState(!1)}onBack(){this.resetAll()}dateIsValid(e){return e instanceof Date&&!isNaN(e)}getNewDate(e,t,a){if(console.log(e,t,a),this.dateIsValid(e))return t?new Date(`${t} ${e.toLocaleTimeString()}`):new Date(`${this.formatDateToReadableString(e)} ${a}`);if(t)return new Date(t.toString());{const e=new Date;return new Date(`${this.formatDateToReadableString(e)} ${a}`)}}formatDateToReadableString(e){return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`}getField(e,t){let a=e[t];return a||(a=e[t.toLocaleLowerCase()]),a}creationForm(){const{createTemplate:e}=this.state;if(e){const a=e.popupTemplate,i={};e.fields.forEach(((e,t)=>i[e.name]=e));const r=new B.default({attributes:{}});return t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",color:"neutral","icon-start":"arrow-left",alignment:"center",scale:"m",type:"button",width:"auto","calcite-hydrated":"",onClick:e=>this.onBack()},"Back"),t.React.createElement("div",{className:"esri-editor__panel-content__section"},a.fieldInfos.map(((e,a)=>{if(e.isEditable&&e.visible){const a=e.fieldName;return r.attributes[a]=void 0,"date"===this.getField(i,a).type?t.React.createElement("div",{style:{display:"flex"}},t.React.createElement(N.CalciteLabel,{style:{width:"50%"}},e.label,t.React.createElement(N.CalciteInput,{type:"date",onInput:t=>{r.attributes[a]=this.getNewDate(r.attributes[e.fieldName],t.target.value)}})),t.React.createElement(N.CalciteLabel,{style:{width:"50%"}},"(time)",t.React.createElement(N.CalciteInput,{type:"time",onCalciteInputInput:t=>r.attributes[a]=this.getNewDate(r.attributes[e.fieldName],null,t.target.value)}))):t.React.createElement(N.CalciteLabel,null,e.label,this.getField(i,a).domain?"coded-value"===this.getField(i,a).domain.type?t.React.createElement(N.CalciteCombobox,{label:a,placeholder:"Select a field",selectionMode:"single",onCalciteComboboxChange:e=>{r.attributes[a]=e.target.value}},this.getField(i,a).domain.codedValues.map((e=>t.React.createElement(N.CalciteComboboxItem,{value:e.code,textLabel:e.name})))):t.React.createElement("div",null,"not implemented - call administrator"):"double"===this.getField(i,a).type||"integer"===this.getField(i,a).type||"small-integer"===this.getField(i,a).type?t.React.createElement(N.CalciteInput,{type:"number",onCalciteInputChange:e=>{r.attributes[a]=e.target.value}}):t.React.createElement(N.CalciteInput,{onCalciteInputChange:e=>{r.attributes[a]=e.target.value}}))}}))),t.React.createElement(N.CalciteButton,{className:"p-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"half",onClick:()=>{console.log("CANCEL")}},"Cancel"),t.React.createElement(N.CalciteButton,{className:"p-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"half",onClick:()=>{console.log("SAVE",r.attributes),e.applyEdits({addFeatures:[r]}).then((e=>{console.log("result",e)}))}},"Save"))}return t.React.createElement("div",null)}creationChildForm(){const{createTemplate:e,parentGraphic:a}=this.state,i=e.relationships.find((e=>e.id===a.relationship.id));if(e&&a){const r=e.popupTemplate,n={};e.fields.forEach(((e,t)=>n[e.name]=e));const s=new B.default({attributes:{}});return t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",color:"neutral","icon-start":"arrow-left",alignment:"center",scale:"m",type:"button",width:"auto","calcite-hydrated":"",onClick:e=>this.onBack()},"Back"),t.React.createElement("div",{className:"esri-editor__panel-content__section"},r.fieldInfos.map(((e,r)=>{if(e.isEditable&&e.visible){const r=e.fieldName;return s.attributes[r]=void 0,a.relationship.keyField!==r&&a.relationship.keyField!==r.toLocaleLowerCase()||(s.attributes[r]=a.graphic.attributes[i.keyField]),"date"===this.getField(n,r).type?t.React.createElement("div",{style:{display:"flex"}},t.React.createElement(N.CalciteLabel,{style:{width:"50%"}},e.label,t.React.createElement(N.CalciteInput,{type:"date",onInput:t=>{s.attributes[r]=this.getNewDate(s.attributes[e.fieldName],t.target.value)}})),t.React.createElement(N.CalciteLabel,{style:{width:"50%"}},"(time)",t.React.createElement(N.CalciteInput,{type:"time",onCalciteInputInput:t=>s.attributes[r]=this.getNewDate(s.attributes[e.fieldName],null,t.target.value)}))):t.React.createElement(N.CalciteLabel,null,e.label,this.getField(n,r).domain?"coded-value"===this.getField(n,r).domain.type?t.React.createElement(N.CalciteCombobox,{label:r,placeholder:"Select a field",selectionMode:"single",onCalciteComboboxChange:e=>{s.attributes[r]=e.target.value}},this.getField(n,r).domain.codedValues.map((e=>t.React.createElement(N.CalciteComboboxItem,{value:e.code,textLabel:e.name})))):t.React.createElement("div",null,"not implemented - call administrator"):"double"===this.getField(n,r).type||"integer"===this.getField(n,r).type||"small-integer"===this.getField(n,r).type?t.React.createElement(N.CalciteInput,{type:"number",value:s.attributes[r]?s.attributes[e.fieldName]:null,onCalciteInputChange:e=>{s.attributes[r]=e.target.value}}):t.React.createElement(N.CalciteInput,{value:s.attributes[r]?s.attributes[e.fieldName]:null,onCalciteInputChange:e=>{s.attributes[r]=e.target.value}}))}}))),t.React.createElement(N.CalciteButton,{className:"p-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"half",onClick:()=>{console.log("CANCEL")}},"Cancel"),t.React.createElement(N.CalciteButton,{className:"p-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"half",onClick:()=>{console.log("SAVE",s.attributes),e.applyEdits({addFeatures:[s]}).then((e=>{console.log("result",e)}))}},"Save"))}return t.React.createElement("div",null)}updateForm(){const{createTemplate:e,graphic:a}=this.state;if(e&&a){const i=e.popupTemplate,r={};return e.fields.forEach(((e,t)=>r[e.name]=e)),t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalciteButton,{className:"m-1",appearance:"solid",color:"neutral","icon-start":"arrow-left",alignment:"center",scale:"m",type:"button",width:"auto","calcite-hydrated":"",onClick:e=>this.onBack()},"Back"),t.React.createElement("div",{className:"esri-editor__panel-content__section"},i.fieldInfos.map(((e,i)=>{if(e.isEditable&&e.visible){const n=e.fieldName;return"date"===this.getField(r,n).type?t.React.createElement("div",{style:{display:"flex"}},t.React.createElement(N.CalciteLabel,{style:{width:"50%"}},e.label,t.React.createElement(N.CalciteInput,{type:"date",onInput:e=>{a.attributes[n]=this.getNewDate(a.attributes[n],e.target.value)},value:a.attributes[n]?this.formatDateToReadableString(new Date(a.attributes[n])):null})),t.React.createElement(N.CalciteLabel,{style:{width:"50%"}},"(time)",t.React.createElement(N.CalciteInput,{type:"time",onCalciteInputInput:e=>a.attributes[n]=this.getNewDate(a.attributes[n],null,e.target.value),value:a.attributes[n]?new Date(a.attributes[n]).toLocaleTimeString():null}))):t.React.createElement(N.CalciteLabel,null,e.label,this.getField(r,n).domain?"coded-value"===this.getField(r,n).domain.type?t.React.createElement(N.CalciteCombobox,{key:i,label:n,placeholder:"Select a field",selectionMode:"single",onCalciteComboboxChange:e=>{a.attributes[n]=e.target.value}},this.getField(r,n).domain.codedValues.map((e=>t.React.createElement(N.CalciteComboboxItem,{selected:a.attributes[n]===e.code,value:e.code,textLabel:e.name})))):t.React.createElement("div",null,"not implemented - call administrator"):"double"===this.getField(r,n).type||"integer"===this.getField(r,n).type||"small-integer"===this.getField(r,n).type?t.React.createElement(N.CalciteInput,{key:i,type:"number",value:a.attributes[n]?a.attributes[n]:null,onCalciteInputChange:e=>{a.attributes[n]=e.target.value}}):t.React.createElement(N.CalciteInput,{key:i,value:a.attributes[n]?a.attributes[n]:null,onCalciteInputChange:e=>{a.attributes[n]=e.target.value}}))}}))),t.React.createElement(N.CalciteButton,{className:"p-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"half",onClick:()=>{console.log("CANCEL")}},"Cancel"),t.React.createElement(N.CalciteButton,{className:"p-1",appearance:"solid",alignment:"center",scale:"m",type:"button",width:"half",onClick:()=>{console.log("UPDATE",a.attributes),e.applyEdits({updateFeatures:[a]}).then((e=>{console.log("result",e)}))}},"Save"))}return t.React.createElement("div",null)}render(){return t.React.createElement(t.React.Fragment,null,t.React.createElement(N.CalcitePickListGroup,{class:"esri-widget__heading esri-item-list__group__header",headingLevel:5,"group-title":"Table"},this.props.tables.map(((e,a)=>t.React.createElement(N.CalciteListItem,{style:{margin:0===a?".5rem 0 0 0":""},onClick:()=>{this.createNewFeature(e)}},t.React.createElement(N.CalciteAction,{text:e.title,icon:"Table","text-enabled":!0,onClick:()=>{this.createNewFeature(e)}}))))))}}class U extends t.React.PureComponent{constructor(e){super(e),this.updateEnableTableEditState=e=>{this.setState({tableOperationEnable:e})},this.tableForm=()=>{switch(this.editTableComponentRef.current.state.mode){case"creation":return this.editTableComponentRef.current.creationForm();case"creationChild":return this.editTableComponentRef.current.creationChildForm();case"update":return this.editTableComponentRef.current.updateForm();default:return t.React.createElement("div",null,"Not implemented")}},this.state={tables:[],tableOperationEnable:!1},this.editorContainer=t.React.createRef(),this.editTableComponentRef=t.React.createRef(),this.isBusy=!1}destroyFeature(){this.editor&&!this.editor.destroyed&&this.editor.destroy()}componentDidMount(){console.log("componentDidMount"),this.editor=new A.default({container:this.editorContainer.current,view:this.props.view}),this.editor.when((()=>{if(console.log("this.state.tables",this.state.tables),this.state.tables&&this.state.tables.length>0){const e=this.editorContainer.current.firstChild.firstChild.lastChild.lastChild.firstChild,a=document.createElement("div");a.setAttribute("style"," margin-top: 20px"),e.appendChild(document.createElement("hr")),e.appendChild(a),t.ReactDOM.render(t.React.createElement($,{ref:this.editTableComponentRef,updateEnableTableEditState:this.updateEnableTableEditState,tables:this.state.tables}),a)}const e=this.editorContainer.current.firstChild.firstChild,a=document.createElement("div");a.setAttribute("slot","header-actions-start"),e.appendChild(a),t.ReactDOM.render(t.React.createElement(N.CalciteButton,{className:"m-2",appearance:"solid",color:"neutral","icon-start":"arrow-left",alignment:"center",scale:"m",type:"button",width:"auto","calcite-hydrated":"",onClick:e=>this.onBack()},"Retour"),a)})),M.default.when((()=>this.editor.activeWorkflow||!this.editor.activeWorkflow),(e=>{this.editor.activeWorkflow&&this.editor.activeWorkflow.type?this.isBusy=!0:this.isBusy&&!this.editor.activeWorkflow&&(this.isBusy=!1,this.props.activateEditor(!1))}));const e=[];this.props.view.map.tables.forEach((t=>{t instanceof P.default&&t.isTable&&t.editingEnabled&&e.push(t)})),this.setState({tables:e})}createChildGraphic(e,t,a){this.props.activateEditor(!0);const i={layer:t,template:t.templates[0]};let r;e.attributes.hasOwnProperty(a.keyField)?r=a.keyField:e.attributes.hasOwnProperty(a.keyField.toLocaleLowerCase())&&(r=a.keyField.toLocaleLowerCase()),r&&(i.template.prototype.attributes[r]=e.attributes[r]),this.editor.startCreateFeaturesWorkflowAtFeatureCreation(i)}createTableChildGraphic(e,t,a){this.editTableComponentRef.current.createNewChildFeature(t,{graphic:e,relationship:a}),this.props.activateEditor(!0)}updateGraphic(e){this.props.activateEditor(!0),this.editor.startUpdateWorkflowAtFeatureEdit(e)}updateTableGraphic(e,t){this.editTableComponentRef.current.updateFeature(e,t),this.props.activateEditor(!0)}deleteGraphic(e){return e.layer.applyEdits({deleteFeatures:[e]})}onBack(){this.editor.cancelWorkflow().then((e=>this.props.activateEditor(!1)))}render(){return t.React.createElement(t.React.Fragment,null,t.React.createElement("div",{style:{height:"100%",overflow:"auto"},className:"editor-custom-styling"},t.React.createElement("div",{ref:this.editorContainer,style:{display:this.state.tableOperationEnable?"none":""}}),this.editTableComponentRef.current&&this.editTableComponentRef.current.state.mode&&this.tableForm()))}}var W=g(7780),V=g(8393);const H={fr:{_widgetLabel:"Panneau contextuel (Esri Belux)",panelTitle:"Panneau contextuel",edit:"Modifier",create:"Créer"}};class J extends t.React.PureComponent{constructor(e){super(e),this.nls=e=>{let t=H[this.props.locale]?H[this.props.locale]:_;return t?t[e]:e},this.activeViewChangeHandler=e=>{if(e){this.view=e.view,this.setState({viewLoaded:!0}),e.view.popup;let t=[];this.view.map.layers.forEach((e=>{e instanceof P.default&&(e.outFields=["*"],t.push(e.load()),this.addEventOnLayer(e)),e instanceof V.default&&e.layers.forEach((e=>{e instanceof P.default&&(e.outFields=["*"],t.push(e.load()),this.addEventOnLayer(e))}))})),this.view.map.tables.forEach((e=>{t.push(e.load()),e instanceof P.default&&this.addEventOnLayer(e)})),this.view.map.layers.forEach((e=>{e instanceof V.default&&e.layers.forEach((e=>{t.push(this.view.whenLayerView(e))})),t.push(this.view.whenLayerView(e))})),W.default.eachAlways(t).then((e=>{this.setState({tablesLoaded:!0}),this.view.popup&&(this.viewPopupAutoOpenDefault=this.view.popup,console.log("this.view.popup.autoOpenEnabled",this.view.popup.autoOpenEnabled),setTimeout((()=>{console.log("this.viewPopupAutoOpenDefault",this.viewPopupAutoOpenDefault)}),5e3),this.view.popup=null),this.view.on("click",(e=>{this.setState({originalScreenPoint:e},(()=>{this.simulateHitTest(e)}))}))}))}},this.updateStateLoading=e=>{this.loading=e,this.setState({loading:this.loading})},this.resetAll=()=>{this.setState({primaryGraphicList:[],primaryGraphic:null,activateEditor:null,primaryGraphicIndex:null}),this.editorComponent.current&&this.editorComponent.current.editor&&this.editorComponent.current.editor.activeWorkflow&&this.editorComponent.current.editor.cancelWorkflow(),this.highlightSelect&&this.highlightSelect.remove()},this.highlightGraphic=(e,t)=>{this.highlightSelect&&this.highlightSelect.remove(),this.view.whenLayerView(e).then((e=>{this.highlightSelect.add(e.highlight(t))})).catch((e=>{console.log("error highlight: ",e)})),console.groupEnd()},this.getLayerFromMap=(e,t)=>{const a=this.view.map.layers.concat(this.view.map.tables);return this.findLayerInCollection(a,e,t)},this.findLayerInCollection=(e,t,a)=>{let i=null;return e.some((e=>e instanceof P.default&&e.url===t&&e.layerId===a?(i=e,!0):e instanceof V.default&&(i=this.findLayerInCollection(e.layers.concat(e.tables),t,a),null!==i))),i},this.searchForRelationships=(e,t)=>{this.updateStateLoading(!0),t.my_custom_refresh_handle&&t.my_custom_refresh_handle.remove(),t.my_custom_refresh_handle=t.on("refresh",(a=>{console.log("REFRESH",a),this.instanceOfRelatedGraphics(e)&&(e.groupRelatedParent&&e.groupRelatedParent.parent?this.emptyRelatedGraphics(e.groupRelatedParent.parent,this.searchForRelationships(e.groupRelatedParent.parent,e.groupRelatedParent.parent.graphic.layer)):this.emptyRelatedGraphics(e,this.searchForRelationships(e,t)))})),t&&t.relationships&&t.relationships.length?(this.getChildrenRelatedData(t.relationships,e,t),this.instanceOfPrimaryGraphic(e)&&this.getParentRelatedData(t.relationships,e,t)):x(`${t.url}/${t.layerId}`,{params:{f:"json",token:this.getToken()}}).then((a=>{a&&a.relationships&&a.relationships.length?(t.objectIdField=a.objectIdField,this.getChildrenRelatedData(a.relationships,e,t)):(this.updateStateLoading(!1),console.log("No relation ship"))})).catch((e=>{console.log("error",e),this.updateStateLoading(!1)}))},this.emptyRelatedGraphics=(e,t)=>{this.instanceOfPrimaryGraphic(e)?this.setState((e=>({primaryGraphic:Object.assign(Object.assign({},e.primaryGraphic),{groupRelatedChildrenGraphics:[],groupRelatedParentGraphics:[]})})),(()=>{})):this.instanceOfRelatedGraphics(e)&&(e.groupRelatedChildrenGraphics=[],this.setState((e=>({primaryGraphic:Object.assign({},e.primaryGraphic)})),(()=>{})))},this.addPromise=()=>{this.numberOfPromises++,this.updateStateLoading(!0)},this.removePromise=()=>{this.numberOfPromises--,0===this.numberOfPromises&&this.updateStateLoading(!1)},this.getRelatedDataChildren=(e,t,a)=>{var i=e.graphic.attributes[t.objectIdField];a.forEach((a=>{this.addPromise(),x(`${t.url}/${t.layerId}/queryRelatedRecords`,{params:{f:"json",objectIds:[i],relationshipId:a.id,returnGeometry:!0,outFields:["*"],token:this.getToken()}}).then((r=>{const n=this.getLayerFromMap(t.url,a.relatedTableId);let s={name:n?n.title:a.name,parent:e,layerFromMap:n,relationship:a,displayedGraphic:null,relatedGraphics:[]};const o=r.relatedRecordGroups.find((e=>e.objectId===i&&e.relatedRecords.length>0));if(o&&n){this.addPromise();const t=n.createQuery();t.objectIds=o.relatedRecords.map((e=>e.attributes[n.objectIdField])),n.queryFeatures(t).then((e=>{if(this.isDeploy&&!n)return;let t;if(n&&n.popupTemplate)t=n.popupTemplate;else if(e.features&&e.features.length>0){const a={fields:e.features[0].layer.fields,title:`${e.features[0].layer.fields[0].name}: {${e.features[0].layer.fields[0].name}}`};t=F.default.createPopupTemplate(a)}s.relatedGraphics=e.features.map((e=>(e.popupTemplate=t,{graphic:e,groupRelatedParent:s,groupRelatedChildrenGraphics:[]})))})).finally((()=>{this.removePromise(),this.instanceOfPrimaryGraphic(e)?this.setState((e=>({primaryGraphic:Object.assign(Object.assign({},e.primaryGraphic),{groupRelatedChildrenGraphics:[...e.primaryGraphic.groupRelatedChildrenGraphics,s]})})),(()=>{console.log("this.state",this.state)})):this.instanceOfRelatedGraphics(e)&&(e.groupRelatedChildrenGraphics=[...e.groupRelatedChildrenGraphics,s],this.setState((e=>({primaryGraphic:Object.assign({},e.primaryGraphic)})),(()=>{console.log("this.state",this.state)})))}))}else this.instanceOfPrimaryGraphic(e)?this.setState((e=>({primaryGraphic:Object.assign(Object.assign({},e.primaryGraphic),{groupRelatedChildrenGraphics:[...e.primaryGraphic.groupRelatedChildrenGraphics,s]})})),(()=>{console.log("this.state",this.state)})):this.instanceOfRelatedGraphics(e)&&(e.groupRelatedChildrenGraphics=[...e.groupRelatedChildrenGraphics,s],this.setState((e=>({primaryGraphic:Object.assign({},e.primaryGraphic)})),(()=>{console.log("this.state",this.state)})))}),(e=>{console.log("error",e)})).finally((()=>{this.removePromise()}))})),0===this.numberOfPromises&&this.updateStateLoading(!1)},this.getRelatedDataParent=(e,t,a)=>{var i=e.graphic.attributes[t.objectIdField];a.forEach((a=>{this.addPromise(),x(`${t.url}/${t.layerId}/queryRelatedRecords`,{params:{f:"json",objectIds:[i],relationshipId:a.id,returnGeometry:!0,outFields:["*"],token:this.getToken()}}).then((r=>{const n=this.getLayerFromMap(t.url,a.relatedTableId),s=r.relatedRecordGroups.find((e=>e.objectId===i&&e.relatedRecords.length>0));if(s&&n){this.addPromise();const t=n.createQuery();t.objectIds=s.relatedRecords.map((e=>e.attributes[n.objectIdField])),n.queryFeatures(t).then((t=>{if(this.isDeploy&&!n)return;let i;if(n&&n.popupTemplate)i=n.popupTemplate;else if(t.features&&t.features.length>0){const e={fields:t.features[0].layer.fields,title:`${t.features[0].layer.fields[0].name}: {${t.features[0].layer.fields[0].name}}`};i=F.default.createPopupTemplate(e)}const r={name:n?n.title:a.name,parent:e,layerFromMap:n,relationship:a,displayedGraphic:null,relatedGraphics:t.features.map((e=>(e.popupTemplate=i,{graphic:e,groupRelatedChildrenGraphics:[]})))};this.setState((e=>({primaryGraphic:Object.assign(Object.assign({},e.primaryGraphic),{groupRelatedParentGraphics:[...e.primaryGraphic.groupRelatedParentGraphics,r]})})))})).finally((()=>{this.removePromise()}))}}),(e=>{console.log("error",e)})).finally((()=>{console.log("FINALLY"),this.removePromise()}))})),0===this.numberOfPromises&&this.updateStateLoading(!1)},this.updateIndex=e=>{this.setState({primaryGraphicIndex:e,primaryGraphic:this.state.primaryGraphicList[e]},(()=>{const e=this.state.primaryGraphic.graphic.layer;e&&e instanceof P.default?this.searchForRelationships(this.state.primaryGraphic,e):console.log("No layer or layer is not feature layer")}))},this.updateStatePrimaryGraphicList=e=>{this.setState({primaryGraphicList:e,primaryGraphicIndex:0})},this.updateStatePrimary=e=>{e?this.setState({primaryGraphic:e},(()=>{const t=e.graphic.layer;t&&t instanceof P.default?this.searchForRelationships(e,t):console.log("No layer or layer is not feature layer")})):this.setState((e=>({primaryGraphic:Object.assign({},e.primaryGraphic)})),(()=>{console.log("this.state",this.state)}))},this.updateStateRelatedGraphic=(e,t)=>{this.setState((e=>({primaryGraphic:Object.assign({},e.primaryGraphic)})),(()=>{const a=e.graphic.layer;a&&a instanceof P.default?this.searchForRelationships(t.displayedGraphic,a):console.log("No layer or layer is not feature layer")}))},this.activateEditor=e=>{this.setState({activateEditor:e})},this.updateStateOriginalScreenPoint=e=>{this.setState({originalScreenPoint:e})},this.state={primaryGraphicList:[],primaryGraphicIndex:void 0,primaryGraphic:void 0,activateEditor:void 0,viewLoaded:!1,tablesLoaded:!1,loading:!1,originalScreenPoint:void 0},this.loading=!1,this.numberOfPromises=0,this.highlightSelect=new I.default,this.sessionManager=t.SessionManager.getInstance(),this.mainSession=this.sessionManager.getMainSession(),this.editorComponent=t.React.createRef(),this.tabsComponentRef=t.React.createRef(),this.updateCounter=0,this.isDeploy="localhost"!==location.hostname&&"127.0.0.1"!==location.hostname}componentDidMount(){console.log("componentDidMount"),this.setState({windowState:(0,t.getAppStore)().getState().widgetsRuntimeInfo[this.props.id].state})}componentWillUnmount(){this.viewPopupAutoOpenDefault&&(this.view.popup=this.viewPopupAutoOpenDefault)}componentDidUpdate(e,a){this.state.primaryGraphic&&a.primaryGraphic&&this.state.primaryGraphic.graphic!=a.primaryGraphic.graphic&&this.highlightGraphic(this.state.primaryGraphic.graphic.layer,this.state.primaryGraphic.graphic);const i=(0,t.getAppStore)().getState().widgetsRuntimeInfo[this.props.id].state;i===t.WidgetState.Closed?this.viewPopupAutoOpenDefault&&(this.view.popup=this.viewPopupAutoOpenDefault):i===t.WidgetState.Opened&&(console.log("Opened",t.WidgetState),this.view&&this.view.popup&&(this.viewPopupAutoOpenDefault=this.view.popup))}instanceOfPrimaryGraphic(e){return"name"in e}instanceOfRelatedGraphics(e){return"graphic"in e}simulateHitTest(e){if(console.log("simulateHitTest",e),this.updateCounter=0,!e)return this.resetAll();this.view.hitTest(e).then((e=>{this.loading||(this.updateStateLoading(!0),this.resetAll(),this.onHitTest(e.results))}))}addEventOnLayer(e){if(console.log(e.title,"layer templates",e.templates),e.templates&&e.templates[0]){const t=new Date;e.templates[0].prototype.attributes.demandeur=this.getUsername(),e.templates[0].prototype.attributes.utilisateur=this.getUsername(),e.templates[0].prototype.attributes.date=t.getTime(),e.templates[0].prototype.attributes.date_fourniture_souhaitee=t.getTime(),e.templates[0].prototype.attributes.datedebut=t.getTime(),e.templates[0].prototype.attributes.email=`${this.getUsername()}@schroeder.lu`,e.templates[0].prototype.attributes.adresse_mail=`${this.getUsername()}@schroeder.lu`}e.on("edits",(t=>{console.log("event",t),console.log("event.updatedFeatures",t.updatedFeatures),this.updateCounter++;let a=!1;t.updatedFeatures.forEach((e=>{e.error&&(a=!0)})),t.addedFeatures.forEach((e=>{e.error&&(a=!0)})),t.deletedFeatures.forEach((e=>{e.error&&(a=!0)})),this.view.whenLayerView(e).then((t=>{M.default.once((()=>!1===t.updating)).then((()=>{a||(console.log("AVANT REFRESH"),e.refresh(),this.activateEditor(!1),this.editorComponent.current&&this.editorComponent.current.editor&&this.editorComponent.current.editor.activeWorkflow&&this.editorComponent.current.editor.cancelWorkflow().then((()=>{this.forceUpdate(),this.tabsComponentRef.current&&this.tabsComponentRef.current.forceUpdate(),this.tabsComponentRef.current.selectedTab&&this.tabsComponentRef.current.selectedTab>0&&setTimeout((()=>{this.tabsComponentRef.current.calciteTabRef.current.childNodes[0].active=!0,this.tabsComponentRef.current.calciteTabRef.current.childNodes[this.tabsComponentRef.current.selectedTab].active=!0}),2e3)})))}))})).catch((()=>{alert("ERROMESSAGE TO BE DONE")}))}))}onHitTest(e){if(e.length){let t;t=this.isDeploy?e.filter((e=>e.graphic&&e.graphic.layer instanceof P.default&&e.graphic.layer.popupEnabled)).map((e=>({graphic:e.graphic,layer:e.graphic.layer}))):e.filter((e=>"graphic"===e.type&&e.layer instanceof P.default&&e.layer.popupEnabled));const a=[];for(let e=0;e<t.length;e++){const i=t[e],r=i.graphic,n=i.layer,s=n.title;if(r.popupTemplate=i.layer.popupTemplate,!r.popupTemplate){const e={fields:n.fields,title:`${n.fields[0].name}: {${n.fields[0].name}}`};r.popupTemplate=F.default.createPopupTemplate(e)}const o={graphic:r,name:s,layerFromMap:n,groupRelatedParentGraphics:[],groupRelatedChildrenGraphics:[]};a.push(o)}if(a.length>0){const e=0,t=a[e];this.setState({primaryGraphicList:a,primaryGraphicIndex:e,primaryGraphic:t},(()=>{this.highlightGraphic(t.graphic.layer,t.graphic)})),t.graphic.layer&&t.graphic.layer instanceof P.default?this.searchForRelationships(t,t.graphic.layer):(console.log("No layer or layer is not feature layer"),this.updateStateLoading(!1))}else this.state.primaryGraphic&&this.resetAll(),this.updateStateLoading(!1)}else this.state.primaryGraphic&&this.resetAll(),this.updateStateLoading(!1)}getToken(){return this.mainSession?this.mainSession.token:(this.mainSession=this.sessionManager.getMainSession(),this.mainSession?this.mainSession.token:"")}getUsername(){return this.mainSession?this.mainSession.username:(this.mainSession=this.sessionManager.getMainSession(),this.mainSession?this.mainSession.username:"")}getChildrenRelatedData(e,t,a){const i=e.map((e=>{if(e&&e.role&&"origin"===e.role||"esriRelRoleOrigin"===e.role)return e})).filter((e=>e));i.length>0?this.getRelatedDataChildren(t,a,i):this.updateStateLoading(!1)}getParentRelatedData(e,t,a){const i=e.map((e=>{if(e&&e.role&&"destination"===e.role||"esriRelRoleDestination"===e.role)return e})).filter((e=>e));i.length>0&&this.getRelatedDataParent(t,a,i)}render(){const{primaryGraphic:a,primaryGraphicList:i,primaryGraphicIndex:r}=this.state;return(0,t.jsx)("div",{className:"widget-popup-panel jimu-widget"},this.props.hasOwnProperty("useMapWidgetIds")&&this.props.useMapWidgetIds&&1===this.props.useMapWidgetIds.length?(0,t.jsx)(t.React.Fragment,null,(0,t.jsx)(e.JimuMapViewComponent,{useMapWidgetId:this.props.useMapWidgetIds[0],onActiveViewChange:this.activeViewChangeHandler}),this.state.viewLoaded&&this.state.tablesLoaded&&(0,t.jsx)(t.React.Fragment,null,(0,t.jsx)("div",{style:{height:"100%",display:this.state.activateEditor?"":"none"},className:"editor-custom-styling"},(0,t.jsx)(U,{ref:this.editorComponent,view:this.view,activateEditor:this.activateEditor}))),(0,t.jsx)(N.CalcitePanel,{loading:this.loading,heading:this.props.config.popupPanelTitle?this.props.config.popupPanelTitle:this.nls("panelTitle"),style:{height:"100%",display:this.state.activateEditor?"none":""}},(0,t.jsx)(t.React.Fragment,null,a&&a.graphic?(0,t.jsx)(t.React.Fragment,null,i.length>1&&(0,t.jsx)("div",{slot:"header-actions-end"},(0,t.jsx)(O,{primaryGraphicList:i,primaryGraphicIndex:r,onIndexChange:this.updateIndex})),(0,t.jsx)(j,{ref:this.tabsComponentRef,editorComponent:this.editorComponent.current,primaryGraphic:a,view:this.view,updatePrimary:this.updateStatePrimary,updateStateRelatedGraphic:this.updateStateRelatedGraphic,updateStatePrimaryGraphicList:this.updateStatePrimaryGraphicList,updateStateLoading:this.updateStateLoading,widget:this})):(0,t.jsx)(t.React.Fragment,null,(0,t.jsx)(N.CalciteNotice,{active:!0,icon:"cursor-click",style:{height:"100%"},width:"half"},(0,t.jsx)("div",{slot:"title"},"Sélectionner un objet")),(0,t.jsx)(N.CalciteNotice,{active:!0,icon:"layers-editable",style:{height:"100%"},width:"half"},(0,t.jsx)("div",{slot:"title"},"Demande d'intervention"),(0,t.jsx)(N.CalciteLink,{slot:"link",title:"my action",onClick:()=>{this.setState({activateEditor:!0})}},"Créer")))))):(0,t.jsx)("div",null,"Sélectionner une carte dans les paramètres"))}}})(),f})())}}}));